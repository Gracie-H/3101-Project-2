---
layout: base.html
title: Home
templateEngineOverride: njk 
---

<!-- 过滤条：Category + Price Range -->
<div class="filters">
  <select id="filter-category" aria-label="Category">
    <option value="">All categories</option>
    <option value="perfume">perfume</option>
    <option value="accessory">accessory</option>
    <option value="shoes">shoes</option>
    <option value="vase">vase</option>
    <option value="decoration">decoration</option>
  </select>

  <select id="filter-price">
    <option value="">All prices</option>
    <option value="0-100">0–100 USD</option>
    <option value="100-200">100–200 USD</option>
    <option value="200-300">200–300 USD</option>
    <option value="300+">300+ USD</option>
  </select>
  
</div>

<!-- 2.5D 漂浮场景 -->
<div id="scene">
  <div id="space">
    {% for post in collections.entry | reverse %}
      {% set price = post.data.price %}
      {% set currency = post.data.currency or "USD" %}
      <a
        class="item"
        href="{{ post.url }}"
        title="{{ post.data.title }}"
        data-category="{{ post.data.category or '' }}"
        data-price="{{ price or '' }}"
      >
        {% if post.data.cover %}

        <img src="{{ post.data.cover | url }}" alt="{{ post.data.title }}">
      {% endif %}
      
        <span class="label">
          <strong>{{ post.data.title }}</strong>
          {% if price %}
            <span class="price"> — ${{ price }} {{ currency }}</span>
          {% endif %}
        </span>
      </a>
    {% endfor %}
  </div>
</div>

<script>
  // ====== 选择器 ======
  const scene  = document.getElementById("scene");
  const space  = document.getElementById("space");
  const items  = Array.from(document.querySelectorAll(".item"));

  const categorySel = document.getElementById("filter-category");
  const priceSel    = document.getElementById("filter-price");

  // ====== 布局参数 ======
  const PADDING = 24;     // 画面内边距
  const GAP     = 24;     // 卡片间距
  const JITTER  = 10;     // 微抖动范围（像素）

  // 价格区间判断
  function inPriceRange(price, token) {
    if (!token) return true;                 // All
    if (Number.isNaN(price)) return !token;  // 无价格仅在“All”中显示

    if (token.endsWith("+")) {
      const min = Number(token.slice(0, -1));
      return price >= min;                  // 300+ ：>= 300
    }
    const [min, max] = token.split("-").map(Number);
    // 采用左闭右开 [min, max)
    return price >= min && price < max;
  }

  // 基准卡片宽度（会按屏幕自动调小/调大）
  function cardWidthFor(w){
    if (w >= 1400) return 260;
    if (w >= 1100) return 240;
    if (w >= 900)  return 220;
    if (w >= 700)  return 200;
    return 180;
  }

  async function waitImages(){
    await Promise.all(items.map(el=>{
      const img = el.querySelector("img");
      return img && img.decode ? img.decode().catch(()=>{}) : Promise.resolve();
    }));
  }

  function layoutGrid(){
    const W = scene.clientWidth;
    const baseW = cardWidthFor(W);
    const estH = Math.round(baseW * 0.66);
    const cols = Math.max(1, Math.floor((W - PADDING*2 + GAP) / (baseW + GAP)));

    let rowHeights = Array(cols).fill(0);
    items.forEach((el, i) => {
      if (el.style.display === "none") return; // 隐藏项不参与排布

      const col = i % cols;
      const img = el.querySelector("img");
      const w   = baseW;
      const h   = img && img.naturalWidth ? Math.round(w * (img.naturalHeight / img.naturalWidth)) : estH;

      const left = PADDING + col * (baseW + GAP) + (Math.random()*2-1)*JITTER;
      const top  = PADDING + rowHeights[col] + (Math.random()*2-1)*JITTER;

      el.style.width = w + "px";
      el.style.transform = `translate3d(${left}px, ${top}px, 0)`;

      rowHeights[col] += h + 32 + GAP; // 32 估算标签/内边距
    });

    const maxH = Math.max(0, ...rowHeights);
    space.style.height = (maxH + PADDING) + "px";
  }

  // ====== 过滤（Category + 价格区间） ======
  function applyFilter(){
    const C = (categorySel?.value || "").trim().toLowerCase();
    const priceToken = priceSel?.value || "";

    items.forEach(el => {
      const cat   = (el.dataset.category || "").toLowerCase();
      const price = parseFloat(el.dataset.price); // 一定是纯数字

      const okC     = !C || cat === C;
      const okPrice = inPriceRange(price, priceToken);

      el.style.display = (okC && okPrice) ? "" : "none";
    });

    // 过滤后重新布局
    requestAnimationFrame(layoutGrid);
  }

  // 事件绑定（注意：只绑定 applyFilter 这个函数）
  categorySel?.addEventListener("change", applyFilter);
  priceSel?.addEventListener("change", applyFilter);

  // ====== 初始化：图片解码 → 布局 → 初次过滤 ======
  (async function init(){
    space.style.transform = "none";
    await waitImages();
    layoutGrid();
    applyFilter();
    window.addEventListener("resize", layoutGrid);
  })();
</script>
